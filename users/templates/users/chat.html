{% extends 'base.html' %}
{% block content %}
<div class="center">
    <div class="card">
        <h2 style='position:relative;width:fit-content;'>{{chat_member}}   
            <span class="position-absolute top-0 start-100 translate-middle p-2 bg-danger border border-light rounded-circle">
          </span></h2>
        <a href="{% url 'chat_lobby' %}"><i class="fa-solid fa-arrow-left fa-xl" style='position:absolute;top:2rem;right:2rem;color:black;'></i></a>
            <div class='chat'>
                {% for message in chat_messages %}
                    {% if message.sender == request.user %}
                    <div class='message_next'>
                        <p class='message_chat_me'>{{message.title}}</p>
                    </div>
                    {% else %}
                    <div class='message_next'>
                        <p class='message_chat_member'>{{message.title}}</p>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        <form action="">
            <div class="input-group mb-3 mt-3">
                <input type="text" class="form-control" placeholder="Type message..." id='new_message'>
                <button class="btn btn-primary" type="submit" id='send'>Send</button>
            </div>
        </form>
    </div>
</div>

<script src="https://js.pusher.com/7.2/pusher.min.js"></script>
<script>
    var pusher = new Pusher('dc6b22fbfe1791ca3f03', {
        cluster: 'eu'
    })
    
    var channel = pusher.subscribe('{{chat.id}}')

    let active_mark = document.getElementsByClassName('rounded-circle')[0]

    let new_message = document.getElementById('new_message')

    let send = document.getElementById('send')

    let chat = document.getElementsByClassName('chat')[0]

    let send_message = location.protocol + '//' + location.host + '/api/send_message/'

    let user_joined_chat = location.protocol + '//' + location.host + '/api/user_joined_chat/'

    let user_left_chat = location.protocol + '//' + location.host + '/api/user_left_chat/'

    fetch(user_joined_chat, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({
        'username': '{{request.user.username}}',
            'room': '{{chat.id}}',
        }),
    }).then((response) => response.json())



    send.addEventListener('click',(e)=>{
        e.preventDefault()
        fetch(send_message, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'username': '{{request.user.username}}',
                'room': '{{chat.id}}',
                'message': new_message.value
            })
        }).then((response) => response.json())
    })

    channel.bind('user_joined_chat',function(data) {
        let username = data.username
        if (username != '{{request.user.username}}') {
            active_mark.classList.remove('bg-danger')
            active_mark.classList.add('bg-success')
        }
    })

    channel.bind('send_message',function(data) {
        let username = data.username
        let message = data.message
        if (username == '{{request.user.username}}') {
            chat.innerHTML = `
                <div class='message_next'>
                    <p class='message_chat_me'>${message}</p>
                </div>
            ` + chat.innerHTML
        } else {
            active_mark.classList.remove('bg-danger')
            active_mark.classList.add('bg-success')
            chat.innerHTML = `
                <div class='message_next'>
                    <p class='message_chat_member'>${message}</p>
                </div>
            ` + chat.innerHTML
        }
        new_message.value = ''
    })

    channel.bind('user_left_chat',function(data) {
        active_mark.classList.remove('bg-success')
        active_mark.classList.add('bg-danger')
    })

    window.addEventListener("beforeunload", (e) => {
        fetch(user_left_chat, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'username': '{{request.user.username}}',
                'room': '{{chat.id}}'
            }),
            })
            .then((response) => response.json())
    })
</script>
{% endblock content %}