{% extends 'base.html' %}
{% block content %}
<style>
    #new_message {
        display: block;
        overflow: hidden;
        resize: none;
    }
</style>
<div class="center">
    <div class="card">
        <h2 style='position:relative;width:fit-content;padding-right:.5em;'>{{chat_member}}
            <span class="position-absolute top-50 start-100 translate-middle p-2 bg-secondary border border-light rounded-circle">
          </span></h2>
        <a href="{% url 'chat_lobby' %}"><i class="fa-solid fa-arrow-left fa-xl" style='position:absolute;top:2rem;right:2rem;color:black;'></i></a>
            <div class='chat'>
                <p style='font-size:10px;margin:0;margin-left:auto;margin-right:auto;' class='created_date'>{{message.created_date}}</p>
                {% for message in chat_messages %}

                    {% if message.sender == request.user %}
                    <p style='font-size:10px;margin:0;margin-left:auto;'>{{message.created_time}}</p>
                    <div class='message_next'>
                        <p class='message_chat_me'>{{message.title|linebreaksbr}}</p>
                    </div>
                    {% else %}
                    <p style='font-size:10px;margin:0;'>{{message.created_time}}</p>
                    <div class='message_next'>
                        <p class='message_chat_member'>{{message.title|linebreaksbr}}</p>
                    </div>
                    {% endif %}
                    <p style='font-size:10px;margin:0;margin-left:auto;margin-right:auto;' class='created_date'>{{message.created_date}}</p>
                {% endfor %}
            </div>
        <form action="">
            <div class="input-group mb-3 mt-3">
                <textarea type="text" rows='1' class="form-control" placeholder="Type message..." id='new_message' maxlength='200'></textarea>
                <button class="btn btn-primary" type="submit" id='send'>Send</button>
            </div>
        </form>
    </div>
</div>

<script src="https://js.pusher.com/7.2/pusher.min.js"></script>
<script>
    var pusher = new Pusher('dc6b22fbfe1791ca3f03', {
        cluster: 'eu'
    })
    
    var channel = pusher.subscribe('{{chat.id}}')

    let active_mark = document.getElementsByClassName('rounded-circle')[0]

    let new_message = document.getElementById('new_message')

    let send = document.getElementById('send')

    let chat = document.getElementsByClassName('chat')[0]

    let send_message = location.protocol + '//' + location.host + '/api/send_message/'

    let user_joined_chat = location.protocol + '//' + location.host + '/api/user_joined_chat/'

    let user_left_chat = location.protocol + '//' + location.host + '/api/user_left_chat/'

    fetch(user_joined_chat, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        },
        body: JSON.stringify({
        'username': '{{request.user.username}}',
            'room': '{{chat.id}}',
        }),
    }).then((response) => response.json())



    send.addEventListener('click',(e)=>{
        e.preventDefault()
        if (new_message.value.length != 0) {
            fetch(send_message, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'username': '{{request.user.username}}',
                    'room': '{{chat.id}}',
                    'message': message_with_br
                })
            }).then((response) => response.json())
        }
    })

    channel.bind('user_joined_chat',function(data) {
        let username = data.username
        if (username != '{{request.user.username}}') {
            active_mark.classList.remove('bg-secondary')
            active_mark.classList.add('bg-success')
        }
    })

    channel.bind('send_message',function(data) {
        let username = data.username
        let message = data.message
        if (username == '{{request.user.username}}') {
            chat.innerHTML = `
                <p style='font-size:10px;margin:0;margin-left:auto;'>${data.created_time}</p>
                <div class='message_next'>
                    <p class='message_chat_me'>${message}</p>
                </div>
            ` + chat.innerHTML
            new_message.value = ''
            new_message.style.height = 'auto';
            new_message.style.height = this.scrollHeight + 'px';
        } else {
            active_mark.classList.remove('bg-secondary')
            active_mark.classList.add('bg-success')
            chat.innerHTML = `
                <p style='font-size:10px;margin:0;'>${data.created_time}</p>
                <div class='message_next'>
                    <p class='message_chat_member'>${message}</p>
                </div>
            ` + chat.innerHTML
        }
    })

    channel.bind('user_left_chat',function(data) {
        active_mark.classList.remove('bg-success')
        active_mark.classList.add('bg-secondary')
    })

    window.addEventListener("beforeunload", (e) => {
        fetch(user_left_chat, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'username': '{{request.user.username}}',
                'room': '{{chat.id}}'
            }),
            })
            .then((response) => response.json())
    })

    let created_dates = document.getElementsByClassName('created_date')
    created_dates = Array.from(created_dates)
    created_dates.reverse()
    let previous_date = ''
    let curr_message = ''
    for (let i=0;created_dates.length>i;i++) {
        curr_message = created_dates[i].innerHTML
        if (curr_message == previous_date) {
            created_dates[i].innerHTML = ''
        }
        previous_date = curr_message
    }

    new_message.addEventListener('input', autoResize, false);
          
    function autoResize() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    }
</script>
{% endblock content %}